name: üöÄ Deploy SaaS to VPS Vultr

on:
  push:
    branches: [ master ]
    paths:
      - 'api/**'
      - 'docs/index-landing.html'
      - 'docs/oauth-callback.html'
      - 'docs/index-saas.html'
      - 'docs/data_loader_saas.js'
      - 'docs/data_adapter.js'
      - 'docs/css/**'
      - 'docs/js/**'
      - 'docs/i18n/**'
      - 'scripts/ops/**'
      - '.github/workflows/deploy-vps.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üîê Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            set -e
            echo "üì• Pulling latest code from GitHub..."
            cd /root/insights-backend
            git fetch origin master
            git reset --hard origin/master

            echo "üê≥ Rebuilding Docker containers..."
            cd api
            docker compose -f docker-compose.prod.yml up -d --build

            echo "üìã Waiting for containers to be healthy..."
            sleep 15

            echo "üåê Deploying frontend files..."
            cp ../docs/index-landing.html /var/www/insights/
            cp ../docs/oauth-callback.html /var/www/insights/
            cp ../docs/index-saas.html /var/www/insights/
            cp ../docs/data_loader_saas.js /var/www/insights/
            cp ../docs/data_adapter.js /var/www/insights/

            echo "üé® Deploying CSS files..."
            mkdir -p /var/www/insights/css
            cp -r ../docs/css/* /var/www/insights/css/

            echo "üì¶ Deploying JS files..."
            mkdir -p /var/www/insights/js
            cp -r ../docs/js/* /var/www/insights/js/

            echo "üåç Deploying i18n files..."
            mkdir -p /var/www/insights/i18n
            cp -r ../docs/i18n/* /var/www/insights/i18n/

            echo "üîß Setting permissions..."
            chown -R www-data:www-data /var/www/insights/

            echo "üìä Syncing ops scripts..."
            mkdir -p /root/scripts
            cp scripts/ops/weekly_pulse.py /root/scripts/

            echo "‚úÖ Deployment complete!"
            echo "üîç Container status:"
            docker ps --filter "name=insights" --format "table {{.Names}}\t{{.Status}}"

            echo ""
            echo "üß™ Running smoke tests..."

            # Wait a bit more for API to be fully ready
            sleep 5

            # Test 1: Health endpoint (direct API call, port 10002)
            if curl -f -s --max-time 10 http://127.0.0.1:10002/health > /dev/null 2>&1; then
              echo "  ‚úÖ API health check passed"
            else
              echo "  ‚ùå API health check failed"
              exit 1
            fi

            # Test 2: Landing page loads (via HTTPS, -k to ignore cert)
            if curl -f -s -k --max-time 10 https://localhost/ | grep -q "Insights"; then
              echo "  ‚úÖ Landing page loads correctly"
            else
              echo "  ‚ùå Landing page failed to load"
              exit 1
            fi

            echo "‚úÖ All smoke tests passed!"
